// -----------------------------------------------------------------
// waypoints_initialList
// -----------------------------------------------------------------
let waypoints_initialList = [
	{
		coords :						[46.72417,12.22766],
		altitude :						null,
		timestamp :						0,
		label :							"Toblach",
		markerIcon:						"violetIcon",
		markerIsDisplayedOnTheMap : 	true
	},
	{
		coords :						[46.825335,12.766398],
		altitude :						null,
		timestamp :						0,
		label :							"Lienz",
		markerIcon:						"violetIcon",
		markerIsDisplayedOnTheMap : 	true
	},
	{
		coords :						[46.795653,13.488621],
		altitude :						null,
		timestamp :						0,
		label :							"Spittal",
		markerIcon:						"violetIcon",
		markerIsDisplayedOnTheMap : 	true
	},
	{
		coords :						[46.614855,13.849669],
		altitude :						null,
		timestamp :						0,
		label :							"Villach",
		markerIcon:						"violetIcon",
		markerIsDisplayedOnTheMap : 	true
	},
	{
		coords :						[46.54387,14.306486],
		altitude :						null,
		timestamp :						0,
		label :							"Ferlach",
		markerIcon:						"violetIcon",
		markerIsDisplayedOnTheMap : 	true
	},
	{
		coords :						[46.641187,14.942265],
		altitude :						null,
		timestamp :						0,
		label :							"Lavamünd",
		markerIcon:						"violetIcon",
		markerIsDisplayedOnTheMap : 	true
	},
	{
		coords :						[46.554764,15.660798],
		altitude :						null,
		timestamp :						0,
		label :							"Maribor",
		markerIcon:						"violetIcon",
		markerIsDisplayedOnTheMap : 	true
	},
	{
		coords :						[46.3134,16.349522],
		altitude :						null,
		timestamp :						0,
		label :							"Varaždin",
		markerIcon:						"violetIcon",
		markerIsDisplayedOnTheMap : 	true
	},
	// MUR -----------------------------------------------------
	{
		coords :						[47.148736,13.378732],
		altitude :						null,
		timestamp :						0,
		label :							"Sticklerhütte",
		markerIcon:						"violetIcon",
		markerIsDisplayedOnTheMap : 	true
	},
	{
		coords :						[47.095605,13.637058],
		altitude :						null,
		timestamp :						0,
		label :							"St Michael",
		markerIcon:						"violetIcon",
		markerIsDisplayedOnTheMap : 	true
	},
	{
		coords :						[47.110458,14.171264],
		altitude :						null,
		timestamp :						0,
		label :							"Murau",
		markerIcon:						"violetIcon",
		markerIsDisplayedOnTheMap : 	true
	},
	{
		coords :						[47.16918,14.66101],
		altitude :						null,
		timestamp :						0,
		label :							"Judenburg",
		markerIcon:						"violetIcon",
		markerIsDisplayedOnTheMap : 	true
	},
	{
		coords :						[47.380576,15.094564],
		altitude :						null,
		timestamp :						0,
		label :							"Leoben",
		markerIcon:						"violetIcon",
		markerIsDisplayedOnTheMap : 	true
	},
	{
		coords :						[47.070969,15.435523],
		altitude :						null,
		timestamp :						0,
		label :							"Graz",
		markerIcon:						"violetIcon",
		markerIsDisplayedOnTheMap : 	true
	},
	{
		coords :						[46.780006,15.530333],
		altitude :						null,
		timestamp :						0,
		label :							"Leibnitz",
		markerIcon:						"violetIcon",
		markerIsDisplayedOnTheMap : 	true
	},
	{
		coords :						[46.686891,15.979026],
		altitude :						null,
		timestamp :						0,
		label :							"Bad Radkersburg",
		markerIcon:						"violetIcon",
		markerIsDisplayedOnTheMap : 	true
	},
	{
		coords :						[46.296484,16.854487],
		altitude :						null,
		timestamp :						0,
		label :							"Legrad",
		markerIcon:						"violetIcon",
		markerIsDisplayedOnTheMap : 	true
	}
];


// -----------------------------------------------------------------
// ICONS
// -----------------------------------------------------------------
const waypoints_iconsList = [
	{
		label:"redIcon",
		iconUrl: 'icons/marker-icon-red.png',
		shadowUrl: 'icons/marker-shadow.png',
		iconSize: [25, 41],
		iconAnchor: [12, 41],
		popupAnchor: [1, -34],
		shadowSize: [41, 41]
	},
	{
		label:"blueIcon",
		iconUrl: 'icons/marker-icon-blue.png',
		shadowUrl: 'icons/marker-shadow.png',
		iconSize: [25, 41],
		iconAnchor: [12, 41],
		popupAnchor: [1, -34],
		shadowSize: [41, 41]
	},
	{
		label:"blackIcon",
		iconUrl: 'icons/marker-icon-black.png',
		shadowUrl: 'icons/marker-shadow.png',
		iconSize: [25, 41],
		iconAnchor: [12, 41],
		popupAnchor: [1, -34],
		shadowSize: [41, 41]
	},
	{
		label:"goldIcon",
		iconUrl: 'icons/marker-icon-gold.png',
		shadowUrl: 'icons/marker-shadow.png',
		iconSize: [25, 41],
		iconAnchor: [12, 41],
		popupAnchor: [1, -34],
		shadowSize: [41, 41]
	},
	{
		label:"greenIcon",
		iconUrl: 'icons/marker-icon-green.png',
		shadowUrl: 'icons/marker-shadow.png',
		iconSize: [25, 41],
		iconAnchor: [12, 41],
		popupAnchor: [1, -34],
		shadowSize: [41, 41]
	},
	{
		label:"greyIcon",
		iconUrl: 'icons/marker-icon-grey.png',
		shadowUrl: 'icons/marker-shadow.png',
		iconSize: [25, 41],
		iconAnchor: [12, 41],
		popupAnchor: [1, -34],
		shadowSize: [41, 41]
	},
	{
		label:"orangeIcon",
		iconUrl: 'icons/marker-icon-orange.png',
		shadowUrl: 'icons/marker-shadow.png',
		iconSize: [25, 41],
		iconAnchor: [12, 41],
		popupAnchor: [1, -34],
		shadowSize: [41, 41]
	},
	{
		label:"violetIcon",
		iconUrl: 'icons/marker-icon-violet.png',
		shadowUrl: 'icons/marker-shadow.png',
		iconSize: [25, 41],
		iconAnchor: [12, 41],
		popupAnchor: [1, -34],
		shadowSize: [41, 41]
	},
	{
		label:"yellowIcon",
		iconUrl: 'icons/marker-icon-yellow.png',
		shadowUrl: 'icons/marker-shadow.png',
		iconSize: [25, 41],
		iconAnchor: [12, 41],
		popupAnchor: [1, -34],
		shadowSize: [41, 41]
	},
];

const waypoints_icons = {};

waypoints_iconsList.forEach(function(icon) {
	waypoints_icons[icon.label] = new L.Icon(icon);
});

// -----------------------------------------------------------------
// Waypoint CLASS
// -----------------------------------------------------------------
const Waypoint = function(initial) {
	// Properties --------------------------------------------------
	this.coords = 						initial.coords ||	[47,0];
	this.altitude = 					initial.altitude || null;
	this.timestamp = 					initial.timestamp || (new Date().getTime());
	this.label = 						initial.label || 	null;
	this.markerIsDisplayedOnTheMap = 	initial.markerIsDisplayedOnTheMap || true;
	this.markerIcon = 					initial.markerIcon || "blueIcon";
	// Should be private -------------------------------------------
	this.myMapMarker = 					null;		// Leaflet current position marker handler
	this.isTarget = 					false;
	// For Rotator usage only --------------------------------------
	this.rotatorType = 					initial.rotatorType || "BOOLEAN";
	this.rotatorIcon = 					initial.rotatorIcon ||"fas fa-map-marker";
	this.rotatorValue = 				initial.rotatorValue || function(value) {
		if (value != undefined) {
			// Setter
			this.markerIsDisplayedOnTheMap = value;
		}
		else {
			// Getter
			return this.markerIsDisplayedOnTheMap;
		}
	};
	this.rotatorInfos = 				initial.rotatorInfos || function() {
		let target = "";
		if (this.isTarget) target = '<i class="fas fa-bullseye green"></i>';
		return target + " ( lat : " + format_coords[app.options.coordinatesFormat](this.coords[0]) + ", lon :" + format_coords[app.options.coordinatesFormat](this.coords[1]) + " )";
	};
}

// Refresh the marker on the map -----------------------------------
Waypoint.prototype.refreshMap = function() {
	if (this.markerIsDisplayedOnTheMap) {
		// Remove marker if exists
		if (this.myMapMarker) app.myMap.removeLayer(this.myMapMarker);
		// Add currentPosition marker
		this.myMapMarker = L.marker(
			this.coords,
			{icon:waypoints_icons[this.markerIcon]}
		).addTo(app.myMap);
		// Display optionnally markers names -------------------
		if (app.options.waypointsNameAreDisplayed) {
			this.myMapMarker.bindTooltip(
				this.label,
				{direction: "center"}
			).openTooltip();
		}
	}
	else {
		// Remove marker if exists
		if (this.myMapMarker) app.myMap.removeLayer(this.myMapMarker);
		this.myMapMarker = null;
	}
};

// writeToDisk ------------------------------------------------------
Waypoint.prototype.writeToSD = function() {
	if (navigator.getDeviceStorage) {
		// WE build the name from the label, replacing unallowed caracters
		let fileName = this.label.trim().replace(/[^A-Za-z0-9]/g, '_') + '.wpt';
		let sdcard = navigator.getDeviceStorage("sdcard");
		let file   = new Blob([JSON.stringify(this,["coords","altitude","timestamp","label"])], {type: "text/plain"});
		let request = sdcard.addNamed(file, "carto/" + fileName);

		request.onsuccess = function () {
		  const name = this.result;
		  toastr.info('Fichier "' + name + '" ajouté sur la carte SD.');
		}

		// An error typically occur if a file with the same name already exist
		request.onerror = function () {
			if (this.error && this.error.name === "NoModificationAllowedError")	  toastr.warning('Ecriture sur la carte SD impossible : ce fichier existe déjà.');
			else {
				toastr.warning('Ecriture sur la carte SD impossible.');
				console.warn(this);
			}
		}
	}
	else console.log("Ecriture non supportée sur PC.");					
};

// -----------------------------------------------------------------
// Waypoints ROTATOR
// -----------------------------------------------------------------
const waypointsOptions = {
	"selectedItemIdPrefix" : 		"waypoint",
	"targetDomSelector" : 			"#menuTarget_1",
	"itemsNumbered":				"reverse"
	/*
	"initialSelectionIndex" : function() {
		let initialSelectionIndex = 0;
		infosOptionsUnitsList.forEach((option,index) => {
			if (option.label === app.options.units) initialSelectionIndex = index;
		});
		return initialSelectionIndex;
	},
	*/
	
}

// Waypoints conversion in objects
waypoints_initialList = waypoints_initialList.map(function(waypoint) {
	return new Waypoint(waypoint);
});

const waypoints = new Rotator(waypoints_initialList,waypointsOptions);

waypoints.refreshMap = function() {
	this.list.forEach(function(waypoint) {
		waypoint.refreshMap();
	});
}

waypoints.target = function(targetWaypoint) {
	if (targetWaypoint != undefined) {
		// Setter :
		this.list.forEach(function(waypoint){
			if (waypoint === targetWaypoint) 	waypoint.isTarget = true;
			else 								waypoint.isTarget = false;
		});
	}
	else {
		// Getter
		const value = this.list.find(waypoint => {
			return waypoint.isTarget;
		});
		return value;
	}
}

// -----------------------------------------------------------------
// waypoints_options ROTATOR
// -----------------------------------------------------------------
let waypoints_options_list = [
	{	
		label:"Définir comme cible",
		rotatorType:"MENU",
		state:"goto"
	},
	{	
		label:"Renommer",
		rotatorType:"MENU",
		state:"rename"
	},
	{	
		label:"Supprimer",
		rotatorType:"MENU",
		state:"delete"
	},
	{	
		label:"Enregistrer sur la carte SD",
		rotatorType:"MENU",
		state:"writeToSD"
	},
	{	
		label:"Changer la couleur",
		rotatorType:"MENU",
		state:"changeColor"
	},
	{	
		label:"Positionner la carte à cet endroit",
		rotatorType:"MENU",
		state:"positionMap"
	},
	{	
		label:"Itinéraire vers ce point",
		rotatorType:"MENU",
		state:"itineraryToThisPoint"
	},
	{	
		label:"Changer d'icône",
		rotatorType:"MENU",
		state:"changeIcon"
	}
];

const waypoints_options_options = {
	"selectedItemIdPrefix" : 		"waypoints_options",
	"targetDomSelector" : 			"#menuTarget_1"
}



const waypoints_options = new Rotator(waypoints_options_list,waypoints_options_options);

// -----------------------------------------------------------------
// icons TABLE ROTATOR
// -----------------------------------------------------------------

let waypoints_iconsRotatorList = waypoints_iconsList.map(function(icon) {return {value:icon.label,iconUrl:icon.iconUrl};});

let waypoints_iconsRotatorOptions = {
	"selectedItemIdPrefix" : 		"waypoints_icons",
	"targetDomSelector" : 			"#menuTarget_1",
	"initialSelectionIndex" : function() {
		let initialSelectionIndex = 0;
		waypoints_iconsRotatorList.forEach((option,index) => {
			if (option.value === waypoints.currentItem().rotatorIcon) initialSelectionIndex = index;
		});
		return initialSelectionIndex;
	},
	"cellHtmlContent": function(element,index,selectedItemIdPrefix) {
		return '<div id="' 
			+ selectedItemIdPrefix + index 
			+ '" class="tableRotator iconsRotator"><img class="waypointsIconsRotator" src="' + element.iconUrl + '" /></div>';
	}
};

let waypoints_iconsRotator = new TableRotator(waypoints_iconsRotatorList,waypoints_iconsRotatorOptions);